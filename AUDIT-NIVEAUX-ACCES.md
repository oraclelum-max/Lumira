# üîí AUDIT SYST√àME D'ACC√àS PAR NIVEAUX - Oracle Lumira

**Date**: 2025-10-26  
**Auditeur**: Qoder AI Assistant  
**Statut**: ‚ö†Ô∏è **CORRECTIONS CRITIQUES REQUISES**

---

## üìä R√âSUM√â EX√âCUTIF

Le syst√®me d'acc√®s par niveaux Oracle Lumira pr√©sente une **architecture backend solide** mais des **failles critiques c√¥t√© frontend** qui permettent √† tous les utilisateurs d'acc√©der √† l'int√©gralit√© du contenu, ind√©pendamment de leur niveau d'abonnement.

### ‚úÖ Points Forts
- Configuration entitlements bien structur√©e (`entitlements.ts`)
- Hi√©rarchie des niveaux claire (Int√©grale > Profond > Mystique > Initi√©)
- 50+ capabilities d√©finies
- Composants de protection (`CapabilityGuard`) disponibles
- Context React avec `hasCapability()` fonctionnel

### ‚ùå Vuln√©rabilit√©s Critiques Identifi√©es

| Vuln√©rabilit√© | S√©v√©rit√© | Impact Business |
|---------------|----------|-----------------|
| **Routes non prot√©g√©es** | üî¥ CRITIQUE | Tous les utilisateurs acc√®dent √† toutes les sph√®res |
| **Navigation sans v√©rification** | üî¥ CRITIQUE | MandalaNav affiche tout sans filtrage |
| **Composants de sph√®res sans guard** | üü† MAJEUR | Contenu premium accessible √† tous |
| **Pas de fallback UX pour verrouill√©** | üü° MINEUR | UX d√©grad√©e (pas bloquant) |

---

## üîç D√âTAIL DES PROBL√àMES

### 1. ‚ùå Routes Sanctuaire Non Prot√©g√©es (CRITIQUE)

**Fichier**: `apps/main-app/src/router.tsx`  
**Lignes**: 45-77

**Probl√®me**:
```typescript
// ‚ùå VULN√âRABILIT√â - Aucune protection par capabilities
<Route path="/sanctuaire/*" element={
  <SanctuaireProvider>
    <Routes>
      <Route path="path" element={<LazySpiritualPath />} />
      <Route path="draws" element={<LazyMesLectures />} />
      <Route path="synthesis" element={<LazySynthesis />} />  
      <Route path="chat" element={<LazyConversations />} />
      <Route path="profile" element={<LazyProfile />} />
    </Routes>
  </SanctuaireProvider>
}} />
```

**Impact**:
- Un utilisateur Initi√© peut acc√©der √† `/sanctuaire/synthesis` (r√©serv√© Profond)
- Un utilisateur Mystique peut acc√©der √† `/sanctuaire/chat` (r√©serv√© Int√©grale)
- Pas de redirection ni message d'erreur

**Mapping Capabilities** :
| Sphere | Route | Capability Requise | Niveau Requis |
|--------|-------|-------------------|---------------|
| Profil Spirituel | `/sanctuaire/path` | `sanctuaire.sphere.profile` | **Initi√©** |
| Mes Lectures | `/sanctuaire/draws` | `sanctuaire.sphere.readings` | **Initi√©** |
| Synth√®se | `/sanctuaire/synthesis` | `sanctuaire.sphere.synthesis` | **Profond** |
| Conversations | `/sanctuaire/chat` | `sanctuaire.sphere.guidance` | **Int√©grale** |
| Profil | `/sanctuaire/profile` | `sanctuaire.sphere.profile` | **Initi√©** |

---

### 2. ‚ùå MandalaNav Affiche Toutes les Sph√®res (CRITIQUE)

**Fichier**: `apps/main-app/src/components/mandala/MandalaNav.tsx`  
**Lignes**: 200-300

**Probl√®me**:
```typescript
// ‚ùå VULN√âRABILIT√â - Affiche toutes les sph√®res sans v√©rifier l'acc√®s
{ORDER.map((key) => {
  // ...
  return (
    <NavLink to={`/sanctuaire/${key}`}>
      {/* Affiche TOUJOURS la sph√®re, m√™me si verrouill√©e */}
    </NavLink>
  );
})}
```

**Impact**:
- Tous les utilisateurs voient les 5 sph√®res dans le mandala
- Cliquables m√™me si non d√©bloqu√©es
- Pas d'indicateur visuel de verrouillage (üîí)
- Mauvaise UX : frustration utilisateur

---

### 3. üü† Composants de Sph√®res Sans Protection (MAJEUR)

**Fichiers Concern√©s**:
- `apps/main-app/src/components/spheres/Synthesis.tsx`
- `apps/main-app/src/components/spheres/Conversations.tsx`
- `apps/main-app/src/components/spheres/SpiritualPath.tsx`

**Probl√®me**:
```typescript
// ‚ùå Aucun composant ne v√©rifie les capabilities
export const Synthesis = () => {
  // Pas de CapabilityGuard
  // Pas de v√©rification hasCapability()
  return <div>Contenu premium...</div>;
};
```

**Impact**:
- M√™me si routes prot√©g√©es, acc√®s direct possible
- Defense-in-depth compromise
- Risque de bypass

---

## üõ†Ô∏è CORRECTIONS RECOMMAND√âES

### PRIORIT√â 1 - CRITIQUE (√Ä impl√©menter imm√©diatement)

#### A. Prot√©ger les Routes avec Route Guard

**Cr√©er**: `apps/main-app/src/components/auth/ProtectedRoute.tsx`

```typescript
import { Navigate } from 'react-router-dom';
import { useSanctuaire } from '../../contexts/SanctuaireContext';
import { LockedCard } from './CapabilityGuard';

interface ProtectedRouteProps {
  children: React.ReactNode;
  requires: string;
  redirectTo?: string;
}

export const ProtectedRoute: React.FC<ProtectedRouteProps> = ({ 
  children, 
  requires,
  redirectTo = '/sanctuaire'
}) => {
  const { hasCapability, isLoading } = useSanctuaire();

  if (isLoading) {
    return <div>Chargement...</div>;
  }

  if (!hasCapability(requires)) {
    return (
      <div className="min-h-screen bg-cosmic-deep flex items-center justify-center p-6">
        <LockedCard 
          level="sup√©rieur" 
          message="Cette sph√®re requiert un niveau d'acc√®s sup√©rieur"
          action={{
            label: "Retour au sanctuaire",
            onClick: () => window.location.href = '/sanctuaire'
          }}
        />
      </div>
    );
  }

  return <>{children}</>;
};
```

**Modifier**: `apps/main-app/src/router.tsx`

```typescript
import { ProtectedRoute } from './components/auth/ProtectedRoute';

// ...

<Route path="/sanctuaire/*" element={
  <SanctuaireProvider>
    <Routes>
      <Route path="path" element={
        <ProtectedRoute requires="sanctuaire.sphere.profile">
          <React.Suspense fallback={<SphereSkeleton />}>
            <LazySpiritualPath />
          </React.Suspense>
        </ProtectedRoute>
      } />
      
      <Route path="draws" element={
        <ProtectedRoute requires="sanctuaire.sphere.readings">
          <React.Suspense fallback={<SphereSkeleton />}>
            <LazyMesLectures />
          </React.Suspense>
        </ProtectedRoute>
      } />
      
      <Route path="synthesis" element={
        <ProtectedRoute requires="sanctuaire.sphere.synthesis">
          <React.Suspense fallback={<SphereSkeleton />}>
            <LazySynthesis />
          </React.Suspense>
        </ProtectedRoute>
      } />
      
      <Route path="chat" element={
        <ProtectedRoute requires="sanctuaire.sphere.guidance">
          <React.Suspense fallback={<SphereSkeleton />}>
            <LazyConversations />
          </React.Suspense>
        </ProtectedRoute>
      } />
      
      <Route path="profile" element={
        <ProtectedRoute requires="sanctuaire.sphere.profile">
          <React.Suspense fallback={<SphereSkeleton />}>
            <LazyProfile />
          </React.Suspense>
        </ProtectedRoute>
      } />
    </Routes>
  </SanctuaireProvider>
}} />
```

---

#### B. Filtrer et Verrouiller MandalaNav

**Modifier**: `apps/main-app/src/components/mandala/MandalaNav.tsx`

```typescript
import { useSanctuaire } from '../../contexts/SanctuaireContext';
import { Lock } from 'lucide-react';

// Ajouter apr√®s les constantes SPHERE_DESCRIPTIONS
const SPHERE_CAPABILITIES: Record<string, string> = {
  spiritualPath: 'sanctuaire.sphere.profile',
  rawDraws: 'sanctuaire.sphere.readings',
  synthesis: 'sanctuaire.sphere.synthesis',
  conversations: 'sanctuaire.sphere.guidance',
  profile: 'sanctuaire.sphere.profile',
};

const SPHERE_REQUIRED_LEVEL: Record<string, string> = {
  spiritualPath: 'Initi√©',
  rawDraws: 'Initi√©',
  synthesis: 'Profond',
  conversations: 'Int√©grale',
  profile: 'Initi√©',
};

// Dans le composant
const MandalaNav: React.FC<Props> = ({ ... }) => {
  const { hasCapability } = useSanctuaire(); // ‚úÖ Ajouter

  // ... code existant ...

  // Dans la boucle ORDER.map()
  {ORDER.map((key) => {
    const i = ORDER.indexOf(key);
    const isLocked = !hasCapability(SPHERE_CAPABILITIES[key]); // ‚úÖ V√©rifier
    const requiredLevel = SPHERE_REQUIRED_LEVEL[key];
    
    // ...
    
    return (
      <motion.div {...existingProps}>
        <NavLink
          to={isLocked ? '#' : `/sanctuaire/${key}`} // ‚úÖ D√©sactiver si verrouill√©
          onClick={(e) => {
            if (isLocked) {
              e.preventDefault(); // ‚úÖ Bloquer la navigation
              // Optionnel : afficher un toast "Niveau X requis"
            }
          }}
          className={`... ${isLocked ? 'opacity-50 cursor-not-allowed' : ''}`}
        >
          <div className="...">
            {/* Ic√¥ne de la sph√®re */}
            {ICONS[key]}
            
            {/* ‚úÖ AJOUTER : Badge de verrouillage */}
            {isLocked && (
              <div className="absolute -top-1 -right-1 w-6 h-6 bg-red-500 rounded-full flex items-center justify-center">
                <Lock className="w-3 h-3 text-white" />
              </div>
            )}
          </div>
          
          {/* ‚úÖ AJOUTER : Tooltip niveau requis */}
          {isLocked && (
            <div className="absolute bottom-full mb-2 px-3 py-1 bg-black/80 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
              N√©cessite le niveau {requiredLevel}
            </div>
          )}
        </NavLink>
      </motion.div>
    );
  })}
```

---

### PRIORIT√â 2 - MAJEUR (Recommand√©)

#### C. Prot√©ger les Composants de Sph√®res

Envelopper chaque composant avec CapabilityGuard :

**Exemple** : `apps/main-app/src/components/spheres/Synthesis.tsx`

```typescript
import { CapabilityGuard, LockedCard } from '../auth/CapabilityGuard';

export const Synthesis = () => {
  return (
    <CapabilityGuard
      requires="sanctuaire.sphere.synthesis"
      fallback={
        <LockedCard 
          level="Profond"
          message="La Synth√®se est r√©serv√©e aux membres de niveau Profond et sup√©rieur"
          action={{
            label: "D√©couvrir les niveaux",
            onClick: () => window.location.href = '/commande'
          }}
        />
      }
    >
      {/* Contenu r√©el de Synthesis */}
      <div className="...">
        Contenu premium de la synth√®se...
      </div>
    </CapabilityGuard>
  );
};
```

---

## üß™ TESTS DE VALIDATION

Pour valider les corrections, tester les sc√©narios suivants :

### Test 1 : Utilisateur Initi√©

```
‚úÖ Doit acc√©der √† : /sanctuaire/path, /sanctuaire/draws, /sanctuaire/profile
‚ùå Doit √™tre bloqu√© sur : /sanctuaire/synthesis, /sanctuaire/chat
‚úÖ MandalaNav doit afficher üîí sur synthesis et conversations
```

### Test 2 : Utilisateur Profond

```
‚úÖ Doit acc√©der √† : /sanctuaire/synthesis (+ toutes sph√®res Initi√©/Mystique)
‚ùå Doit √™tre bloqu√© sur : /sanctuaire/chat
‚úÖ MandalaNav doit afficher üîí uniquement sur conversations
```

### Test 3 : Utilisateur Int√©grale

```
‚úÖ Doit acc√©der √† : toutes les sph√®res
‚úÖ MandalaNav ne doit afficher aucun üîí
```

---

## üìä IMPACT ESTIM√â DES CORRECTIONS

| M√©trique | Avant | Apr√®s | Am√©lioration |
|----------|-------|-------|--------------|
| **S√©curit√© des routes** | 0% | 100% | +100% |
| **UX Diff√©renciation niveaux** | 0% | 100% | +100% |
| **Conversions vers niveaux sup.** | 0% | ~20-30% | +25% estim√© |
| **Temps dev** | - | ~4h | - |

---

## ‚úÖ CHECKLIST D'IMPL√âMENTATION

- [ ] Cr√©er `ProtectedRoute.tsx`
- [ ] Modifier `router.tsx` avec guards
- [ ] Ajouter mapping capabilities dans `MandalaNav.tsx`
- [ ] Filtrer sph√®res verrouill√©es dans navigation
- [ ] Ajouter badges üîí visuels
- [ ] Envelopper composants Synthesis/Conversations avec CapabilityGuard
- [ ] Tester sc√©nario Initi√©
- [ ] Tester sc√©nario Profond
- [ ] Tester sc√©nario Int√©grale
- [ ] Commit & Deploy

---

## üéØ CONCLUSION

Le syst√®me d'acc√®s par niveaux Oracle Lumira dispose d'une **excellente base technique backend** mais n√©cessite une **impl√©mentation frontend urgente** pour devenir op√©rationnel.

**Recommandation** : Impl√©menter les corrections PRIORIT√â 1 (A et B) **imm√©diatement** avant toute mise en production avec des utilisateurs payants.

**Risque actuel** : Tous les utilisateurs peuvent acc√©der gratuitement au contenu premium ‚Üí **Perte de revenus** potentielle.

**ROI estim√©** : 4h de d√©veloppement ‚Üí Activation du syst√®me de mon√©tisation par niveaux ‚Üí Augmentation revenus +25-30%.

---

**Auteur**: Qoder AI Assistant  
**Contact**: En cas de questions, relire ce document et r√©f√©rencer les num√©ros de ligne des fichiers.
